<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="../../layui/css/layui.css">
<link rel="stylesheet" href="../../assets/css/view.css" />
<link rel="icon" href="/favicon.ico">
<script type="text/javascript" src="../../js/jquery-1.8.3.min.js"></script>
<title>客户资源管理</title>
<style type="text/css">
*{margin:0;padding:0;}
#addResource input[type="text"] {
	width: 200px;
}

#addResource>.layui-form>div {
	line-height: 50px;
}

#addResource label {
	line-height: 30px;
}

.float_left {
	float: left;
}
.mainDiv{
	padding: 20px;width: 460px;margin: auto;display: none;
}
.mainDiv>div{
	line-height: 50px;
}
.width_div{
	width: 200px;
}
.infoTrdiv span{
	font-weight: 800;
}
</style>
</head>

<body class="layui-view-body">
	<div class="layui-content">
		<div class="layui-page-header">
			<div class="pagewrap title">
				<span> <a href="">首页</a> <a href="">客户管理</a> <a><cite>客户资源管理</cite></a>
				</span>
				<!--<h2 class="title">客户资源管理</h2> class="layui-breadcrumb"-->
			</div>
		</div>
		<input type="hidden" class="roleId">
		<div class="layui-row">
			<div class="layui-card">
				<div class="layui-card-body">
					<div class="form-box">
						<div class="layui-form layui-form-item">
							<div class="layui-inline">
								<div class="layui-input-inline">
									<select name="name" class="layui-select cliName">
										<option value="clientName">客户姓名</option>
										<option value="phone">联系电话</option>
									</select>
								</div>
								<div class="layui-input-inline">
									<input type="text" name="" class="layui-input staffName">
								</div>
								<div class="layui-form-mid">分配状态：</div>
								<div class="layui-input-inline">
									<select name="allotState" class="layui-select allot">
										<option value="0">状态选择</option>
										<option value="2">已分配</option>
										<option value="1">未分配</option>
									</select>
								</div>
								<div class="layui-input-inline">
									<button class="layui-btn layui-btn-blue refer_but">查询</button>
								</div>
							</div>
						</div>
						<button class="layui-btn layui-btn-blue add_but">
							<i class="layui-icon">&#xe654;</i>添加
						</button>
						<table class="layui-hide" id="test" lay-filter="test"></table>
						<script type="text/html" id="barDemo">
							<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="edit">修改</a>
							<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="see">查看</a>
							{{#  if($('.roleId').val() != 4){ }}
								{{#  if(d.allotState == '未分配'){ }}
    							<a class="layui-btn layui-btn-xs layui-bg-blue" lay-event="allot">分配</a>
 								{{#  } else { }}
									<a class="layui-btn layui-btn-xs  layui-btn-disabled" lay-event="">分配</a>
 								{{#  } }}
							{{#  } }}
							
	 					</script>
						<script type="text/html" id="toolbarDemo" class="layui-table">
						  <div class="layui-btn-container">
						  	
						  </div>
						</script>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="addResource" style="display: none; padding: 20px; width: 630px; margin: auto;">
		<form class="layui-form resourceadd" action="">
			<div class="float_left">
				<label class="layui-form-label">客户编码：</label>
				<div class="layui-input-inline">
					<input type="text" name="clientId" class="layui-input cid" placeholder="输入无效" />
				</div>
			</div>
			<div class="float_left">
				<label class="layui-form-label">客户姓名：</label>
				<div class="layui-input-inline">
					<input type="text" name="clientName" class="layui-input clientName" />
				</div>
			</div>

			<div class="float_left sex">
				<label class="layui-form-label">性别：</label> 
				<input type="radio" name="sex" value="男" title="男" checked class="man" /> 
				<input type="radio" name="sex" value="女"  title="女" checked="" class="girl" />
			</div>
			<div class="float_left" style="margin-left: 68px;">
				<label class="layui-form-label">生日：</label>
				<div class="layui-input-inline">
					<input type="text" name="birthday" class="layui-input" id="date" />
				</div>
			</div> 
		 	<div class="float_left">
				<label class="layui-form-label">类型：</label>
				<div class="layui-input-inline">
					<select name="clientType" class="typeb">
						<option value="普通" selected="selected">普通客户</option>
						<option value="银卡" selected="">银卡客户</option>
						<option value="金卡" selected="">金卡客户</option>
						<option value="vip" selected="">vip客户</option>
					</select>
				</div>
			</div>
			<div class="float_left">
				<label class="layui-form-label">状态：</label>
				<div class="layui-input-inline">
					<select name="state" class="state">
						<option value="1" selected="selected">启用</option>
						<option value="2" selected="">禁用</option>
						<option value="3" selected="">流失</option>
					</select>
				</div>
			</div>
			<div class="float_left">
				<label class="layui-form-label">手机：</label>
				<div class="layui-input-inline">
					<input type="text" name="phone" class="layui-input phone" />
				</div>
			</div>
			<div class="float_left">
				<label class="layui-form-label">办公电话：</label>
				<div class="layui-input-inline">
					<input type="text" name="workPhone" class="layui-input workPhone" />
				</div>
			</div>
		 	<div class="float_left">
				<label class="layui-form-label">电子邮箱：</label>
				<div class="layui-input-inline">
					<input type="text" name="email" class="layui-input email" />
				</div>
			</div>
			<div class="float_left">
				<label class="layui-form-label">家庭电话：</label>
				<div class="layui-input-inline">
					<input type="text" name="familyPhone" class="layui-input familyPhone" />
				</div>
			</div>
			<div style="clear: both;"></div>
			<div>
				<label class="layui-form-label">联系地址：</label>
				<textarea name="contactAddress" placeholder="请输入" class="layui-textarea address" style="width: 514px;"></textarea>
			</div>
			<div>
				<label class="layui-form-label">备注详情：</label>
				<textarea name="remark" placeholder="请输入" class="layui-textarea remark" style="width: 514px;"></textarea>
			</div>
			<div style="text-align: center">
				<button type="button" class="layui-btn addSub" style="">增加</button>
				<button type="button" class="layui-btn updateSub" style="">修改</button>
				<button type="button" class="layui-btn fanhui" style="margin-left: 99px">返回</button>
			</div>
		</form>
	</div>
	<div class="mainDiv">
		<div class="infoTrdiv">
			<div class="width_div float_left"><span>客户姓名：</span></div>
			<div class="width_div float_left"><span>客户生日：</span></div>
			<div style="clear: both;"></div>
		</div>
		<div class="infoTrdiv">
			<div class="width_div float_left"><span>性别：</span></div>
			<div class="width_div float_left"><span>类型：</span></div>
			<div style="clear: both;"></div>
		</div>
		<div class="infoTrdiv">
			<div class="width_div float_left"><span>手机：</span></div>
			<div class="width_div float_left"><span>办公电话：</span></div>
			<div style="clear: both;"></div>
		</div>
		<div class="infoTrdiv">
			<div class="width_div float_left"><span>家庭电话：</span></div>
			<div class="width_div float_left"><span>邮箱：</span></div>
			<div style="clear: both;"></div>
		</div>
		<div class="infoTrdiv">
			<div style="margin-left: 30px;">
				<span>联系地址：</span>
			</div>
		</div>
		<div class="infoTrdiv">
			<div style="margin-left: 30px;">
				<span>备注信息：</span>
			</div>
		</div>
		<div class="infoTrdiv">
			<div style="text-align: center;">
				<span>客户状态：</span>
			</div>
		</div>
	</div>
	<script src="../../layui/layui.js"></script>
	<script type="text/javascript">
		$.ajax({
			type:"post",
			url:"/ClientRelations_action/getUserInfos",
			success:function(t){
				var user  = t.user;
				$(".roleId").val(user.roleId);
				console.log(user.roleId);
			}
		})
	</script>
	<script>
	$(function(){ 
	      dataTable();
	});
	function dataTable(){
		layui.use([ 'table','laydate' ], function() {
			let table = layui.table;
			let layer = layui.layer;
			let laydate = layui.laydate;
			let form = layui.form;
			// 弹出层
			let mylay;
			
			table.render({
				elem : '#test',
				url : '../../../selectAllClient',
				toolbar : '#toolbarDemo',
				cols : [ [ 
					{field : 'clientId',width : 80,title : '',sort : true}, 
					{field : 'clientName',width : 120,title : '客户姓名',align : 'center'}, 
					{field : 'sex',width : 60,title : '性别'}, 
					{field : 'clientType',width : 100,title : '类型',minWidth : 100}, 
					{field : 'state',width : 100,title : '状态'}, 
					{field : 'allotState',width : 90,title : '分配状态'}, 
					{field : 'inTime',width : 0,title : '录入时间'}, 
					{field : 'staffName',width : 120,title : '录入人'}, 
					{width : 200,title : "操作",toolbar : "#barDemo"}
				] ],
				page : true,
				limits : [2,5,10,15,20]
			});
			var data;
			//监听工具条
			table.on('tool(test)', function(obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
				data = obj.data; //获得当前行数据
		//		console.log(data);	//页面打印是否获取到数据
				var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
				var tr = obj.tr; //获得当前行 tr 的DOM对象
				if (layEvent == 'see') { //查看
					$(".mainDiv").empty();
					let textData = "";
					textData += "<div class='infoTrdiv'><div class='width_div float_left'><span>客户姓名：</span>"+data.clientName+"</div>"+
					"<div class='width_div float_left'><span>客户生日：</span>"+data.birthday+"</div><div style='clear: both;'></div></div>"+
				    "<div class='infoTrdiv'><div class='width_div float_left'><span>性别：</span>"+data.sex+"</div>"+
					"<div class='width_div float_left'><span>类型：</span>"+data.clientType+"</div><div style='clear: both;'></div></div>"+
					"<div class='infoTrdiv'><div class='width_div float_left'><span>手机：</span>"+data.phone+"</div>"+
					"<div class='width_div float_left'><span>办公电话：</span>"+data.workPhone+"</div><div style='clear: both;'></div></div>"+
					"<div class='infoTrdiv'><div class='width_div float_left'><span>家庭电话：</span>"+data.familyPhone+"</div>"+
					"<div class='width_div float_left'><span>邮箱：</span>"+data.email+"</div><div style='clear: both;'></div></div>"+
					"<div class='infoTrdiv'><div style='margin-left: 30px;'><span>联系地址：</span>"+data.contactAddress+"</div></div>"+
					"<div class='infoTrdiv'><div style='margin-left: 30px;'><span>备注信息：</span>"+data.remark+"</div></div>"+
					"<div class='infoTrdiv'><div style='text-align: center;'><span>客户状态：</span>"+data.state+"</div></div>"
					$(".mainDiv").append(textData);
					layer.open({
						type : 1,
						anim : 3,
						area : [ '600px', '500px' ],
						content : $('.mainDiv')
					//这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
					});
				} else if (layEvent === 'edit') { //修改
					$(".updateSub").css("display","inline-block");
					$(".updateSub").css("margin-right","50px");
					$(".addSub").css("display","none");
					$(".cid").val(data.clientId);
					$(".clientName").val(data.clientName);
					$("#date").val(data.birthday);
					if ($(".man").val() == data.sex) {
						$(".girl").removeAttr("checked")
						$(".man").attr("checked",true);
					}else{
						$(".man").removeAttr("checked");
						$(".girl").attr("checked",true);
					}
					$("#date").val(data.birthday);
					$(".typeb>option").each(function(){ //遍历全部option
						var txt = $(this).text(); //获取option的内容
						if (txt == data.clientType) {
							$(".typeb:first").removeAttr("selected");
							$(this).attr("selected","selected");
							return false;
						}
					});
					$(".state option").each(function(){ //遍历全部option
				        var txt = $(this).val(); //获取option的内容
						if (data.state == "正常") {
							$(this).attr("selected","selected");
							return false;
						}else if (data.state == "被禁用") {
							if (txt == '2') {
								$(".state:first").removeAttr("selected");
								$(this).attr("selected","selected");
								return false;
							}
						}else if(data.state == "已流失"){
							if (txt == '3') {
								$(".state:first").removeAttr("selected");
								$(this).attr("selected","selected");
								return false
							}
						}
					});
					$(".phone").val(data.phone);
					$(".workPhone").val(data.workPhone);
					$(".email").val(data.email);
					$(".familyPhone").val(data.familyPhone);
					$(".address").val(data.contactAddress);
					$(".remark").val(data.remark);
					mylay = layer.open({
						type : 1,
						anim : 2,
						area : [ '700px', '600px' ],
						title: '修改客户信息',
						content : $('#addResource'),
						success:function(layero,index){
							laydate.render({
								elem: '#date'
							});
							form.render();
						}
					});
				} else if (layEvent == 'allot') {//分配
					if (data.allotState == "未分配" && data.state == "正常" && data.chanceId != undefined) {
						layer.open({
							type : 2,
							anim : 2,
							area : [ '700px', '600px' ],
							title: '分配',
							content : 'allot.html',
							success:function(layero,index){
								 var body = layer.getChildFrame('body', index);	//调用弹出页面css dom元素
								 var iframe = window['layui-layer-iframe'+index]; //调用弹出页面js方法
								 body.find(".formClientId").val(data.clientId); //客户id
								 body.find(".formChanceId").val(data.chanceId); //机会id
							}
						});
					}else if (data.chanceId == undefined) {
						layer.msg("该客户没有任何给机会！");
					}else if (data.allotState == "已分配"){
						layer.msg("客户已分配");
					}else if(data.state != "正常"){
						layer.msg("客户已被禁用或流失，无法分配");
					}
				}
			});
			$(".refer_but").on('click',function() {
			    table.reload('test',{
			        method:'post',
			        where:{
						allotState:$(".allot").val(),
						conditionName:$(".cliName").val(),
						condition:$(".staffName").val()
			        }
			    });
			});
			
			//监听提交
			form.on('submit(formDemo)', function(data) {
				layer.msg(JSON.stringify(data.field));
				return false;
			});
			$(".add_but").click(function() {
				$(".addSub").css("display","inline-block");
				$(".addSub").css("margin-right","50px");
				$(".updateSub").css("display","none");
				$('.resourceadd')[0].reset();
				mylay = layer.open({
					type : 1,
					anim : 1,
					area : [ '700px', '600px' ],
					title: '增加客户信息',
					content : $('#addResource'),
					success:function(layero,index){
						laydate.render({
							elem: '#date'
						});
						form.render();
					}
				//这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
				});
			});
			$(".fanhui").on("click", function() {
				layer.close(mylay);
			});
			$(".cid").focus(function() {
				layer.msg("编码输入无效的");
			});
			
			// 资源增加ajax
			$(".addSub").on('click',function(){
				let info = $(".resourceadd").serialize();
				$.ajax({
					url:'../../../addResource',
					type:'post',
					data: info,
					success:function(msg){
						layer.msg(msg.msg);
						layer.close(mylay);
					},error(){
						alert("哦豁网络错误！");
					}
				});
			});
			// 资源修改ajax
			$(".updateSub").on('click',function(){
			 	$.ajax({
					url:'../../../updateResource',
					type:'post',
					data: {
						clientId: data.clientId,
						clientName: $(".clientName").val(),
						sex: $(".sex input[checked]").val(),
						birthday: $("#date").val(),
						clientType: $(".typeb").val(),
						state: $(".state").val(),
						phone: $(".phone").val(),
						workPhone: $(".workPhone").val(),
						email: $(".email").val(),
						familyPhone:$(".familyPhone").val(),
						contactAddress:$(".address").val(),
						remark:$(".remark").val()
					},
					success:function(msg){
						layer.msg(msg.msg);
						layer.close(mylay);
						$(".refer_but").click();
					},error(){
						alert("壕鳥网络错误！");
					}
				});
			});
		});
	}
	function referclick(){
		$(".refer_but").click();
	}
	</script>
</body>
</html>